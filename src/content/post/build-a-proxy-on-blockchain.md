---
title: "在区块链上部署代理节点"
publishDate: "17 Dec 2024"
description: "上周在配置本地代理的时候产生了一个点子就是能不能把代理节点放到区块链上，这样就不需要到处去买机场服务，找到最快的线路最便宜的节点，尤其是某个机场被封锁的话，基本所有节点就废了"
tags: ["blockchain", "web3", "proxy"]
---

在[上周的博客](/posts/journal/week2)中讲到了这个想法，所谓的机场就是卖服务器的ip和带宽，有没办法把自己闲置的vps上的闲置的带宽共享出来，自己用不完能让别人也能用呢？现在vps很廉价，很多人都买过vps，一个月二三十块钱，但是上面跑什么很多人是没想法的，配置好翻墙就放在那了，但是个人也用不满，白白浪费了计算资源。

共享经济很美好，但是要解决这个问题必须解决收费的问题，不可能白白分享我的带宽给别人用吧，那么收费的话该怎么收，像滴滴一样让每个车主注册为滴滴司机，然后平台给发钱吗？没这个能力做这个事。区块链是我想到的一个解法，让每个翻墙节点都成为区块链矿工，你给别人提供代理服务的同时，也在挖矿因此会收到区块链挖矿奖励。而客户端要使用区块链节点的翻墙服务，必须要锁定一部分资金到区块链上，就像买机场订阅一样，每个月预付一部分钱，但这里是智能合约或者预定义好的算法来将客户端付出的费用拿出来奖励矿工节点。

## 方案设计

顺着这个大体的思路，我想了2个实现方案，一个是用智能合约，一个是自己做一条链。接下来我会比较这两种方案的可行性。

### 选项一 使用智能合约来管理代理节点

复用现有的区块链如：ETH、SOL, polkadot，先实现一个管理费用的智能合约，部署到区块链上，这个合约的一个作用是请求鉴权。我们都知道 `socks5` 协议要传入账号和密码，比如说我通过访问百度，命令行是

```bash
curl -x socks5://user:password@192.0.0.1:8080 https://baidu.com
```

代理节点收到这个请求要先鉴权，鉴权方式很多，要么是配置文件写死了已经授权的账号密码，要么就是从数据库里读取有权限的用户名和密码。如果搬到智能合约这个场景里，那么智能合约里肯定要实现一段鉴权的方法。例如判断当前客户端用户是否付了月费。如果智能合约返回了 是，说明这个人已经付费过了，那么代理软件就可以放行，就会去帮忙转发目标请求，然后将响应发回给客户端。

收费呢？如果我的代理服务器运行了一个月了，陆陆续续也很多人用过，如何从他们充的月费里，提取出我应得的收益呢？这个问题很难，给成百上千的人发放收益确实是很难的事情，我也没有好办法。智能合约是一个很昂贵的设备，每次交互都要消耗一笔 gas，不可能我维护一个脚本定时请求智能合约，让智能合约把钱发给每个服务端节点吧，这样我可能亏得gas都付不起，而且万一这个脚本停了，那么几千人的账没法结了。

因此智能合约无法解决如下问题：

1. 服务端自动领取收益的问题
2. 服务端软件去合约上鉴权的性能问题，本来我访问google，希望100ms内就返回，这可好，调用infura接口去合约鉴权一下就浪费了1s时间，用户得卡死。

### 选项二 将代理软件集成到区块链节点上

上面讨论了智能合约的实现方案，主要问题在于费用计算上。这里我们讨论下将代理节点内置到区块链节点上的实现方案。这个方案首先就解决了结算的问题，因为区块链就是每时每刻都在算账，每一个新的区块生成，就必然包含了验证人节点的出块奖励，只要稍微修改一下，就可以将客户端用户付的月费，定时分配给服务端节点。

至于鉴权效率的问题也顺便解决了，因为区块链节点就是自身，那么查询客户端的付费状态只要在本地的storage里面查询就行了，不走网络查询本地的rocksdb还是很快的。

这个方案当然也有一些问题，包括：

1. 占用较多硬盘空间，前期用户不多，有个5G的硬盘空间应该够用
2. 占用 CPU，内存资源。区块链就是取交易，打包，然后广播出去让其他节点验算。可能要比较高的配置才能跑起来

## 最终方案

比较了上面2种方案，我还是觉得区块链的实现更靠谱，虽然前期自己发一条链成本很高，但是如果这个模式跑通了，后期维护成本就很低了。因此这是我最终的方案：

1. 使用 polkadot substrate 框架自己建一条新链，代币名字叫 SST (Secure Socks5 Token)
2. 共识算法使用 PoA 也就是只有授权的节点能加入进来，未来再考虑升级到 PoS
3. 使用自建的 telemetry 来保存每个节点的ip信息，这样只要运行了我的节点，我的服务端就能知道你的公网ip和代理端口
4. 自建一个 http server给客户端用，首先要能调用 telemetry 服务器来返回节点列表。然后还要有一个付费的界面，让用户能够充值买 SST 以及锁定月费。


翻墙的需求只有中国等少数几个国家的人有，这么实现的区块链还有别的用途，包括：

1. 拿来做ip池，写爬虫的人可以用，想换多少IP就多少IP
2. 隐私保护。目前上网能知道你的位置信息，如果加一层代理，想在互联网隐身就更简单了。

这个方案是否会被攻击呢？肯定会的，但是哪个项目能绝对安全呢？如果真的做大了引来别人的敌视了，对于早期创始人来说肯定已经赚到钱了
