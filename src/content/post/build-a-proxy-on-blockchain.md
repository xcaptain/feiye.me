---
title: "在区块链上部署代理节点"
publishDate: "17 Dec 2024"
updatedDate: "20 Dec 2024"
description: "上周在配置本地代理的时候产生了一个点子就是能不能把代理节点放到区块链上，这样就不需要到处去买机场服务，找到最快的线路最便宜的节点，尤其是某个机场被封锁的话，基本所有节点就废了"
tags: ["blockchain", "web3", "proxy"]
---

在[上周的博客](/posts/journal/week2)中讲到了这个想法，所谓的机场就是卖服务器的ip和带宽，有没办法把自己闲置的vps上的闲置的带宽共享出来，自己用不完能让别人也能用呢？现在vps很廉价，很多人都买过vps，一个月二三十块钱，但是上面跑什么很多人是没想法的，配置好翻墙就放在那了，但是个人也用不满，白白浪费了计算资源。

共享经济很美好，但是要解决这个问题必须解决收费的问题，不可能白白分享我的带宽给别人用吧，那么收费的话该怎么收，像滴滴一样让每个车主注册为滴滴司机，然后平台给发钱吗？没这个能力做这个事。区块链是我想到的一个解法，让每个翻墙节点都成为区块链矿工，你给别人提供代理服务的同时，也在挖矿因此会收到区块链挖矿奖励。而客户端要使用区块链节点的翻墙服务，必须要锁定一部分资金到区块链上，就像买机场订阅一样，每个月预付一部分钱，但这里是智能合约或者预定义好的算法来将客户端付出的费用拿出来奖励矿工节点。

## 方案设计

顺着这个大体的思路，我想了2个实现方案，一个是用智能合约，一个是自己做一条链。接下来我会比较这两种方案的可行性。

### 选项一 使用智能合约来管理代理节点

复用现有的区块链如：ETH、SOL, polkadot，先实现一个管理费用的智能合约，部署到区块链上，这个合约的一个作用是请求鉴权。我们都知道 `socks5` 协议要传入账号和密码，比如说我通过访问百度，命令行是

```bash
curl -x socks5://user:password@192.0.0.1:8080 https://baidu.com
```

代理节点收到这个请求要先鉴权，鉴权方式很多，要么是配置文件写死了已经授权的账号密码，要么就是从数据库里读取有权限的用户名和密码。如果搬到智能合约这个场景里，那么智能合约里肯定要实现一段鉴权的方法。例如判断当前客户端用户是否付了月费。如果智能合约返回了 是，说明这个人已经付费过了，那么代理软件就可以放行，就会去帮忙转发目标请求，然后将响应发回给客户端。

收费呢？如果我的代理服务器运行了一个月了，陆陆续续也很多人用过，如何从他们充的月费里，提取出我应得的收益呢？这个问题很难，给成百上千的人发放收益确实是很难的事情，我也没有好办法。智能合约是一个很昂贵的设备，每次交互都要消耗一笔 gas，不可能我维护一个脚本定时请求智能合约，让智能合约把钱发给每个服务端节点吧，这样我可能亏得gas都付不起，而且万一这个脚本停了，那么几千人的账没法结了。

因此智能合约无法解决如下问题：

1. 服务端自动领取收益的问题
2. 服务端软件去合约上鉴权的性能问题，本来我访问google，希望100ms内就返回，这可好，调用infura接口去合约鉴权一下就浪费了1s时间，用户得卡死。

### 选项二 将代理软件集成到区块链节点上

上面讨论了智能合约的实现方案，主要问题在于费用计算上。这里我们讨论下将代理节点内置到区块链节点上的实现方案。这个方案首先就解决了结算的问题，因为区块链就是每时每刻都在算账，每一个新的区块生成，就必然包含了验证人节点的出块奖励，只要稍微修改一下，就可以将客户端用户付的月费，定时分配给服务端节点。

至于鉴权效率的问题也顺便解决了，因为区块链节点就是自身，那么查询客户端的付费状态只要在本地的storage里面查询就行了，不走网络查询本地的rocksdb还是很快的。

![整体架构草图](./sst-1.jpg)

这个方案当然也有一些问题，包括：

1. 占用较多硬盘空间，前期用户不多，有个5G的硬盘空间应该够用
2. 占用 CPU，内存资源。区块链就是取交易，打包，然后广播出去让其他节点验算。可能要比较高的配置才能跑起来，大部分人的vps都是低配的，要想想看能不能降低服务器要求

---

2024/12/20 更新:

昨晚又想到一个问题，一些很常见的ip代理池都有几百万甚至上千万的ip，如：

1. [https://iproyal.com/](https://iproyal.com/)
2. [123proxy.cn](123proxy.cn)

如果采用上面的区块链验证人节点即代理节点的方案，因为区块链验证人数量是有上限的，按照区块链的思想，每个区块被打包出来后，要广播到网络里给其他人去验证，验证通过才会达成共识，大家都把这个区块加到自己的链上，如果节点太多，共识的时间可能会很长。

这里列举我查询到的一些知名公链的验证人数量[来源](https://solana.com/news/validator-health-report-march-2023)：

1. solana: 2400
2. ethereum: 3000
3. avalanche: 1100
4. polygon: 77
5. near: 211

如果想做一个区块链有1万个以上的验证人节点是太难了，更别说10万、100万。因此上面的方案二实践中是不可行的，要修改一下。

在这里我再提出一个链上结合链下的新方案

### 选项三 区块链验证人节点与代理节点分离

上面说到验证人数量有上限，那我们就做一个少数节点参与的公链，让代理节点单独运行在自己的服务器上，代理节点当作是一个区块链交互的客户端，定时往区块链上上报心跳包，以表示自己在线，只有在线的节点才能对外提供代理服务。

这样的架构核心可以是一个只有 7 个节点的区块链网络，链下有 100 万个代理节点，定时往区块链上提交心跳交易。然后区块链上维护一个算法，定时把用户充值的月费，发放给这100万个代理节点。

链上链下分离会产生一个新问题，提交的数据不可信。100万节点都往上提交心跳交易，万一有人伪造了咋办，没有对外提供代理服务你也提交，然后区块链还给你发奖励，这就是白嫖，对这个网络是有损害的。要解决这个问题我想到一个简单的办法，在代理程序节点里内置一个 RSA 私钥，我们都知道在数字签名理论里，用私钥签名，可以用公钥验签，只要把私钥保存在我们的代理节点里面，公钥保存在区块链里，这样每次发心跳交易时，用私钥签名一下，区块链就好验证是来自我们自己发布的代理节点的请求。一定程度上避免了恶意节点（此处假设只要我们的代理节点在线，那就一定是能对外提供服务的）。

这个方案有一个问题就是私钥内置在客户端程序里，万一有攻击者提取出了这个私钥，就可以无限发心跳交易，就可以不付出但是依然拿奖励，如何解决呢？我有一个简单的办法就是模仿以太坊的 NPoS 协议，让代理节点锁定一部分资金到区块链上，这样即使私钥泄漏，攻击者也要付出一定的成本，这样就不会无限发心跳交易了。

再从经济学角度分析一下闲置VPS机主、黑客、个人用户的利益：

1. 闲置VPS机主：他们可以将闲置的带宽共享出去，获得一定的收益，实时赚币，随时可提现离开。唯一损耗的一点就是 VPS 带宽，但是如果这部分资源本来就是浪费的，贡献出来又会怎样呢？
2. 黑客：黑客假设提取到了私钥，那他会无限发交易去攻击这个网络吗？可能性很小，因为假设每个地址发心跳交易都要求有100个 SST 的余额，那他造10个地址就需要存 1000 个 SST，可以小规模的做恶，很难大规模做恶。如果说他把私钥公开到互联网上，那只能让所有节点都升级客户端，使用新版本的私钥。
3. 个人用户：个人用户最大的好处就是可以匿名上网，百万ip可以随时切换，价格也会更便宜，因为使用的都是别人的闲置资源，也没有中间商赚差价。

---
